/*
  backbone-pageable
  http://github.com/wyuenho/backbone-pageable

  Copyright (c) 2013 Jimmy Yuen Ho Wong
  Licensed under the MIT @license.
*/
(function(e){if("object"==typeof exports)module.exports=e(require("underscore"),require("backbone"));else if("function"==typeof define&&define.amd)define(["underscore","backbone"],e);else if("undefined"!=typeof _&&"undefined"!=typeof Backbone){var t=Backbone.PageableCollection,r=Backbone.PageableCollection=e(_,Backbone);Backbone.PageableCollection.noConflict=function(){return Backbone.PageableCollection=t,r}}})(function(e,t){"use strict";function r(t,r){if(t*=1,!e.isNumber(t)||e.isNaN(t)||!e.isFinite(t)||~~t!==t)throw new TypeError("`"+r+"` must be a finite integer");return t}function a(e){for(var t,r,a,s,i={},n=decodeURIComponent,o=e.split("&"),l=0,c=o.length;c>l;l++){var u=o[l];t=u.split("="),r=t[0],a=t[1]||!0,r=n(r),s=i[r],d(s)?s.push(a):i[r]=s?[s,a]:a}return i}function s(){var t=arguments[0],r=e.toArray(arguments).slice(1),a=t.comparator;t.comparator=null;try{t.reset.apply(t,r)}finally{t.comparator=a,a&&t.sort()}return t}var i=e.extend,n=e.omit,o=e.clone,l=e.each,c=e.pick,u=e.contains,f=e.isEmpty,h=e.pairs,g=e.invert,d=e.isArray,P=e.isFunction,p=e.keys,v=e.isUndefined,m=e.result,y=e.bind,k=Math.ceil,b=t.Collection.prototype,S=/[\s'"]/g,_=/[<>\s'"]/g,C=t.Collection.extend({state:{firstPage:1,lastPage:null,currentPage:null,pageSize:25,totalPages:null,totalRecords:null,sortKey:null,order:-1},mode:"server",queryParams:{currentPage:"page",pageSize:"per_page",totalPages:"total_pages",totalRecords:"total_entries",sortKey:"sort_by",order:"order",directions:{"-1":"asc",1:"desc"}},initialize:function(e,t){t=t||{};var r=this.mode=t.mode||this.mode||R.mode,a=i({},R.queryParams,this.queryParams,t.queryParams||{});a.directions=i({},R.queryParams.directions,this.queryParams.directions,a.directions||{}),this.queryParams=a;var s=this.state=i({},R.state,this.state,t.state||{});s.currentPage=null==s.currentPage?s.firstPage:s.currentPage,"server"==r||null!=s.totalRecords||f(e)||(s.totalRecords=e.length),this.switchMode(r,i({fetch:!1,resetState:!1,models:e},t));var n=t.comparator;if(s.sortKey&&!n&&this.setSorting(s.sortKey,s.order,t),"server"!=r){if(n&&t.full){delete this.comparator;var l=this.fullCollection;l.comparator=n,l.sort()}e&&!f(e)&&(this.getPage(s.currentPage),e.splice.apply(e,[0,e.length].concat(this.models)))}this._initState=o(this.state)},_makeFullCollection:function(e,r){var a,s,i,n=["url","model","sync","comparator"],o=this.constructor.prototype,l={};for(a=0,s=n.length;s>a;a++)i=n[a],v(o[i])||(l[i]=o[i]);var c=new(t.Collection.extend(l))(e,r);for(a=0,s=n.length;s>a;a++)i=n[a],this[i]!==o[i]&&(c[i]=i);return c},_makeCollectionEventHandler:function(e,t){return function(r,a,n,c){var u=e._handlers;l(p(u),function(r){var a=u[r];e.off(r,a),t.off(r,a)});var f=o(e.state),h=f.firstPage,g=0===h?f.currentPage:f.currentPage-1,d=f.pageSize,P=g*d,m=P+d;if("add"==r){var y,b,S,_,c=c||{};if(n==t)b=t.indexOf(a),b>=P&&m>b&&(_=e,y=S=b-P);else{y=e.indexOf(a),b=P+y,_=t;var S=v(c.at)?b:c.at+P}if(++f.totalRecords,e.state=e._checkState(f),_){_.add(a,i({},c||{},{at:S}));var C=y>=d?a:!v(c.at)&&m>S&&e.length>d?e.at(d):null;if(C){var R=n._events.add,x={onAdd:!0};if(R.length){var w=R[R.length-1],q=w.callback;w.callback=function(){try{q.apply(this,arguments),e.remove(C,x)}finally{w.callback=q}}}else e.remove(C,x)}}}if("remove"==r)if(c.onAdd)delete c.onAdd;else{if(--f.totalRecords){var z=f.totalPages=k(f.totalRecords/d);f.lastPage=0===h?z-1:z,f.currentPage>z&&(f.currentPage=f.lastPage)}else f.totalRecords=null,f.totalPages=null;e.state=e._checkState(f);var E,K=c.index;n==e?((E=t.at(m))&&e.push(E),t.remove(a)):K>=P&&m>K&&(e.remove(a),E=t.at(g*(d+K)),E&&e.push(E))}if("reset"==r||"sort"==r){if(c=n,n=a,n==e&&"reset"==r){var B=t.models.slice(0,P),N=t.models.slice(P+e.models.length);c=i(c,{silent:!0}),s(t,B.concat(e.models).concat(N),c)}("reset"==r||n==t)&&((f.totalRecords=t.models.length)||(f.totalRecords=null,f.totalPages=null,f.lastPage=f.currentPage=f.firstPage),e.state=e._checkState(f),n==e&&t.trigger(r,t,c),s(e,t.models.slice(P,m),c))}l(p(u),function(r){var a=u[r];l([e,t],function(e){e.on(r,a);var t=e._events[r];t.unshift(t.pop())})})}},_checkState:function(e){var t=this.mode,a=this.links,s=e.totalRecords,i=e.pageSize,n=e.currentPage,o=e.firstPage,l=e.totalPages;if(null!=s&&null!=i&&null!=n&&null!=o&&("infinite"==t?a:!0)){if(s=r(s,"totalRecords"),i=r(i,"pageSize"),n=r(n,"currentPage"),o=r(o,"firstPage"),1>i)throw new RangeError("`pageSize` must be >= 1");if(l=e.totalPages=k(s/i),0>o||o>1)throw new RangeError("`firstPage must be 0 or 1`");if(e.lastPage=0===o?l-1:l,"infinite"==t){if(!a[n+""])throw new RangeError("No link found for page "+n)}else{if(0===o&&(o>n||n>=l))throw new RangeError("`currentPage` must be firstPage <= currentPage < totalPages if 0-based. Got "+n+".");if(1===o&&(o>n||n>l))throw new RangeError("`currentPage` must be firstPage <= currentPage <= totalPages if 1-based. Got "+n+".")}}return e},setPageSize:function(e,t){return e=r(e,"pageSize"),t=t||{},this.state=this._checkState(i({},this.state,{pageSize:e,totalPages:k(this.state.totalRecords/e)})),this.getPage(this.state.currentPage,t)},switchMode:function(e,t){if(!u(["server","client","infinite"],e))throw new TypeError('`mode` must be one of "server", "client" or "infinite"');t=t||{fetch:!0,resetState:!0};var r=this.state=t.resetState?o(this._initState):this._checkState(i({},this.state));this.mode=e;var a,s=this,c=this.fullCollection,f=this._handlers=this._handlers||{};if("server"==e||c)"server"==e&&c&&(l(p(f),function(e){a=f[e],s.off(e,a),c.off(e,a)}),delete this._handlers,this._fullComparator=c.comparator,delete this.fullCollection);else{c=this._makeFullCollection(t.models||[]),c.pageableCollection=this,this.fullCollection=c;var h=this._makeCollectionEventHandler(this,c);l(["add","remove","reset","sort"],function(e){f[e]=a=y(h,{},e),s.on(e,a),c.on(e,a)}),c.comparator=this._fullComparator}if("infinite"==e)for(var g=this.links={},d=r.firstPage,P=k(r.totalRecords/r.pageSize),v=0===d?P-1:P||d,m=r.firstPage;v>=m;m++)g[m]=this.url;else this.links&&delete this.links;return t.fetch?this.fetch(n(t,"fetch","resetState")):this},hasPrevious:function(){var e=this.state,t=e.currentPage;return"infinite"!=this.mode?t>e.firstPage:!!this.links[t-1]},hasNext:function(){var e=this.state,t=this.state.currentPage;return"infinite"!=this.mode?e.lastPage>t:!!this.links[t+1]},getFirstPage:function(e){return this.getPage("first",e)},getPreviousPage:function(e){return this.getPage("prev",e)},getNextPage:function(e){return this.getPage("next",e)},getLastPage:function(e){return this.getPage("last",e)},getPage:function(e,t){var a=this.mode,o=this.fullCollection;t=t||{fetch:!1};var l=this.state,c=l.firstPage,u=l.currentPage,h=l.lastPage,g=l.pageSize,d=e;switch(e){case"first":d=c;break;case"prev":d=u-1;break;case"next":d=u+1;break;case"last":d=h;break;default:d=r(e,"index")}this.state=this._checkState(i({},l,{currentPage:d}));var P=(0===c?d:d-1)*g,p=o&&o.length?o.models.slice(P,P+g):[];return"client"!=a&&("infinite"!=a||f(p))||t.fetch?("infinite"==a&&(t.url=this.links[d]),this.fetch(n(t,"fetch"))):s(this,p,n(t,"fetch"))},sync:function(e,r,a){var s=this;if("infinite"==s.mode){var n=a.success,o=s.state.currentPage;a.success=function(e,t,r){var l=s.links,c=s.parseLinks(e,i({xhr:r},a));c.first&&(l[s.state.firstPage]=c.first),c.prev&&(l[o-1]=c.prev),c.next&&(l[o+1]=c.next),n&&n(e,t,r)}}return(b.sync||t.sync).call(s,e,r,a)},parseLinks:function(e,t){var r=t.xhr.getResponseHeader("Link"),s=["first","prev","previous","next","last"],i={};l(r.split(","),function(e){var t=e.split(";"),r=t[0].replace(_,""),a=t.slice(1);l(a,function(e){var t=e.split("="),a=t[0].replace(S,""),n=t[1].replace(S,"");"rel"==a&&u(s,n)&&("previous"==n?i.prev=r:i[n]=r)})});var n,c,f=i.last||"";if(c=(n=f.indexOf("?"))?f.slice(n+1):""){var h=a(c),g=o(this.state),d=this.queryParams,P=g.pageSize,p=1*h[d.totalRecords],v=1*h[d.currentPage],m=h[d.totalPages];p||(v?p=(0===g.firstPage?v+1:v)*P:m&&(p=m*P)),p&&(g.totalRecords=p),this.state=this._checkState(g)}return delete i.last,i},parse:function(e){var t=this.parseState(e,o(this.queryParams),o(this.state));return t&&(this.state=this._checkState(i({},this.state,t))),this.parseRecords(e)},parseState:function(t,r,a){if(t&&2===t.length&&e.isObject(t[0])&&d(t[1])){var s=o(a),i=t[0];return l(h(n(r,"directions")),function(e){var t=e[0],r=e[1];s[t]=i[r]}),i.order&&(s.order=1*g(r.directions)[i.order]),s}},parseRecords:function(t){return t&&2===t.length&&e.isObject(t[0])&&d(t[1])?t[1]:t},fetch:function(e){e=e||{};var t=this._checkState(this.state),r=this.mode;"infinite"!=r||e.url||(e.url=this.links[t.currentPage]);var l=e.data||{},u=m(e,"url")||m(this,"url")||"",f=u.indexOf("?");-1!=f&&(i(l,a(u.slice(f+1))),u=u.slice(0,f)),e.url=u,e.data=l;var g,d,y,k,S="client"==this.mode?c(this.queryParams,"sortKey","order"):n(c(this.queryParams,p(R.queryParams)),"directions"),_=h(S),C=o(this);for(g=0;_.length>g;g++)d=_[g],y=d[0],k=d[1],k=P(k)?k.call(C):k,null!=t[y]&&null!=k&&(l[k]=t[y]);t.sortKey&&t.order?l[S.order]=this.queryParams.directions[t.order+""]:t.sortKey||delete l[S.order];var x=h(n(this.queryParams,p(R.queryParams)));for(g=0;x.length>g;g++)d=x[g],k=d[1],k=P(k)?k.call(C):k,l[d[0]]=k;var w=this.fullCollection,q=this.links;if("server"!=r){var z=this,E=e.success;return e.success=function(a,n,o){o=o||{},v(e.silent)?delete o.silent:o.silent=e.silent;var l=a.models,c=t.currentPage;if("client"==r)s(w,l,o);else if(q[c]){var u=t.pageSize,f=(0===t.firstPage?c:c-1)*u,h=w.models,g=h.slice(0,f),d=h.slice(f+u);h=g.concat(l).concat(d),w.update(h,i({silent:!0,sort:!1},o)),w.comparator&&w.sort(),w.trigger("reset",w,o)}else w.add(l,i({at:w.length,silent:!0},o)),w.trigger("reset",w,o);E&&E(a,n,o)},b.fetch.call(z,i({},e,{silent:!0}))}return b.fetch.call(this,e)},_makeComparator:function(e,t){var r=this.state;return e=e||r.sortKey,t=t||r.order,e&&t?function(r,a){var s,i=r.get(e),n=a.get(e);return 1===t&&(s=i,i=n,n=s),i===n?0:n>i?-1:1}:void 0},setSorting:function(e,t,r){var a=this.state;a.sortKey=e,a.order=t=t||a.order;var s=this.fullCollection,n=!1,o=!1;e||(n=o=!0);var l=this.mode;r=i({side:"client"==l?l:"server",full:!0},r);var c=this._makeComparator(e,t),u=r.full,f=r.side;return"client"==f?u?(s&&(s.comparator=c),n=!0):(this.comparator=c,o=!0):"server"!=f||u||(this.comparator=c),n&&delete this.comparator,o&&s&&delete s.comparator,this}}),R=C.prototype;return C});