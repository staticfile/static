var BJ_REPORT=function(a){if(a.BJ_REPORT)return a.BJ_REPORT;var b=[],c={},d={id:0,uin:0,url:"",offline_url:"",offline_auto_url:"",ext:null,level:4,ignore:[],random:1,delay:1e3,submit:null,repeat:5,offlineLog:!1,offlineLogExp:5,offlineLogAuto:!1},e={db:null,ready:function(a){var b=this;if(!window.indexedDB||!d.offlineLog)return d.offlineLog=!1,a();if(this.db)return void setTimeout(function(){a(null,b)},0);var c=1,e=window.indexedDB.open("badjs",c);return e?(e.onerror=function(b){return a(b),d.offlineLog=!1,console.log("indexdb request error"),!0},e.onsuccess=function(c){b.db=c.target.result,setTimeout(function(){a(null,b)},500)},void(e.onupgradeneeded=function(a){var b=a.target.result;b.objectStoreNames.contains("logs")||b.createObjectStore("logs",{autoIncrement:!0})})):(d.offlineLog=!1,a())},insertToDB:function(a){var b=this.getStore();b.add(a)},addLog:function(a){this.db&&this.insertToDB(a)},addLogs:function(a){if(this.db)for(var b=0;b<a.length;b++)this.addLog(a[b])},getLogs:function(a,b){if(this.db){var c=this.getStore(),d=c.openCursor(),e=[];d.onsuccess=function(c){var d=c.target.result;d?(d.value.time>=a.start&&d.value.time<=a.end&&d.value.id==a.id&&d.value.uin==a.uin&&e.push(d.value),d["continue"]()):b(null,e)},d.onerror=function(a){return b(a),!0}}},clearDB:function(a){if(this.db){var b=this.getStore();if(!a)return void b.clear();var c=Date.now()-24*(a||2)*3600*1e3,d=b.openCursor();d.onsuccess=function(a){var d=a.target.result;d&&(d.value.time<c||!d.value.time)&&(b["delete"](d.primaryKey),d["continue"]())}}},getStore:function(){var a=this.db.transaction("logs","readwrite");return a.objectStore("logs")}},f={isOBJByType:function(a,b){return Object.prototype.toString.call(a)==="[object "+(b||"Object")+"]"},isOBJ:function(a){var b=typeof a;return"object"===b&&!!a},isEmpty:function(a){return null===a?!0:f.isOBJByType(a,"Number")?!1:!a},extend:function(a,b){for(var c in b)a[c]=b[c];return a},processError:function(a){try{if(a.stack){var b=a.stack.match("https?://[^\n]+");b=b?b[0]:"";var c=b.match(":(\\d+):(\\d+)");c||(c=[0,0,0]);var d=f.processStackMsg(a);return{msg:d,rowNum:c[1],colNum:c[2],target:b.replace(c[0],""),_orgMsg:a.toString()}}return a.name&&a.message&&a.description?{msg:JSON.stringify(a)}:a}catch(e){return a}},processStackMsg:function(a){var b=a.stack.replace(/\n/gi,"").split(/\bat\b/).slice(0,9).join("@").replace(/\?[^:]+/gi,""),c=a.toString();return b.indexOf(c)<0&&(b=c+"@"+b),b},isRepeat:function(a){if(!f.isOBJ(a))return!0;var b=a.msg,e=c[b]=(parseInt(c[b],10)||0)+1;return e>d.repeat}},g=a.onerror;a.onerror=function(b,c,d,e,h){var i=b;h&&h.stack&&(i=f.processStackMsg(h)),f.isOBJByType(i,"Event")&&(i+=i.type?"--"+i.type+"--"+(i.target?i.target.tagName+"::"+i.target.src:""):""),p.push({msg:i,target:c,rowNum:d,colNum:e,_orgMsg:b}),o(),g&&g.apply(a,arguments)};var h=function(a,b){var c=[],e=[],g=[];if(f.isOBJ(a)){a.level=a.level||d.level;for(var h in a){var i=a[h];if(!f.isEmpty(i)){if(f.isOBJ(i))try{i=JSON.stringify(i)}catch(j){i="[BJ_REPORT detect value stringify error] "+j.toString()}g.push(h+":"+i),c.push(h+"="+encodeURIComponent(i)),e.push(h+"["+b+"]="+encodeURIComponent(i))}}}return[e.join("&"),g.join(","),c.join("&")]},i=[],j=function(a,b){return b=f.extend({id:d.id,uin:d.uin,time:new Date-0},b),e.db?void e.addLog(b):(e.db||i.length||e.ready(function(a,b){b&&i.length&&(b.addLogs(i),i=[])}),void i.push(b))},k=function(){var a=document.createElement("script");a.src=d.offline_auto_url||d.url.replace(/badjs$/,"offlineAuto")+"?id="+d.id+"&uin="+d.uin,window._badjsOfflineAuto=function(a){a&&BJ_REPORT.reportOfflineLog()},document.head.appendChild(a)},l=[],m=0,n=function(){if(clearTimeout(m),l.length){var a=d._reportUrl+l.join("&")+"&count="+l.length+"&_t="+ +new Date;if(d.submit)d.submit(a);else{var b=new Image;b.src=a}m=0,l=[]}},o=function(a){if(d._reportUrl){for(var c=Math.random()>=d.random;b.length;){var e=!1,g=b.shift();if(g.msg=(g.msg+""||"").substr(0,500),!f.isRepeat(g)){var i=h(g,l.length);if(f.isOBJByType(d.ignore,"Array"))for(var k=0,o=d.ignore.length;o>k;k++){var p=d.ignore[k];if(f.isOBJByType(p,"RegExp")&&p.test(i[1])||f.isOBJByType(p,"Function")&&p(g,i[1])){e=!0;break}}e||(d.offlineLog&&j("badjs_"+d.id+d.uin,g),c||20==g.level||(l.push(i[0]),d.onReport&&d.onReport(d.id,g)))}}a?n():m||(m=setTimeout(n,d.delay))}},p=a.BJ_REPORT={push:function(a){var c=f.isOBJ(a)?f.processError(a):{msg:a};if(d.ext&&!c.ext&&(c.ext=d.ext),c.from||(c.from=location.href),c._orgMsg){var e=c._orgMsg;delete c._orgMsg,c.level=2;var g=f.extend({},c);g.level=4,g.msg=e,b.push(c),b.push(g)}else b.push(c);return o(),p},report:function(a,b){return a&&p.push(a),b&&o(!0),p},info:function(a){return a?(f.isOBJ(a)?a.level=2:a={msg:a,level:2},p.push(a),p):p},debug:function(a){return a?(f.isOBJ(a)?a.level=1:a={msg:a,level:1},p.push(a),p):p},reportOfflineLog:function(){return window.indexedDB?void e.ready(function(a,b){if(b){var c=new Date-0-24*d.offlineLogExp*3600*1e3,e=new Date-0;b.getLogs({start:c,end:e,id:d.id,uin:d.uin},function(a,b){var f=document.createElement("iframe");f.name="badjs_offline_"+(new Date-0),f.frameborder=0,f.height=0,f.width=0,f.src="javascript:false;",f.onload=function(){var a=document.createElement("form");a.style.display="none",a.target=f.name,a.method="POST",a.action=d.offline_url||d.url.replace(/badjs$/,"offlineLog"),a.enctype.method="multipart/form-data";var g=document.createElement("input");g.style.display="none",g.type="hidden",g.name="offline_log",g.value=JSON.stringify({logs:b,userAgent:navigator.userAgent,startDate:c,endDate:e,id:d.id,uin:d.uin}),f.contentDocument.body.appendChild(a),a.appendChild(g),a.submit(),setTimeout(function(){document.body.removeChild(f)},1e4),f.onload=null},document.body.appendChild(f)})}}):void BJ_REPORT.info("unsupport offlineLog")},offlineLog:function(a){return a?(f.isOBJ(a)?a.level=20:a={msg:a,level:20},p.push(a),p):p},init:function(a){if(f.isOBJ(a))for(var c in a)d[c]=a[c];var g=parseInt(d.id,10);return g&&(/qq\.com$/gi.test(location.hostname)&&(d.url||(d.url="//badjs2.qq.com/badjs"),d.uin||(d.uin=parseInt((document.cookie.match(/\buin=\D+(\d+)/)||[])[1],10))),d._reportUrl=(d.url||"/badjs")+"?id="+g+"&uin="+d.uin+"&"),b.length&&o(),e._initing||(e._initing=!0,e.ready(function(a,b){b&&setTimeout(function(){b.clearDB(d.offlineLogExp),setTimeout(function(){d.offlineLogAuto&&k()},5e3)},1e3)})),p},__onerror__:a.onerror};return"undefined"!=typeof console&&console.error&&setTimeout(function(){var a=((location.hash||"").match(/([#&])BJ_ERROR=([^&$]+)/)||[])[2];a&&console.error("BJ_ERROR",decodeURIComponent(a).replace(/(:\d+:\d+)\s*/g,"$1\n"))},0),p}(window);"undefined"!=typeof module&&(module.exports=BJ_REPORT);