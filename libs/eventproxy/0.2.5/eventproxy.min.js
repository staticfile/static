/*!
  This file is used for define the EventProxy library.
  @author <a href="mailto:shyvo1987@gmail.com">Jackson Tian</a>
  @version 0.2.5
 */;(function(name,definition){var hasDefine=typeof define==='function',hasExports=typeof module!=='undefined'&&module.exports;if(hasDefine){define(definition);}else if(hasExports){module.exports=definition();}else{this[name]=definition();}})('EventProxy',function(){var EventProxy=function(){if(!(this instanceof EventProxy)){return new EventProxy();}
this._callbacks={};this._fired={};};EventProxy.prototype.addListener=function(ev,callback){this._callbacks=this._callbacks||{};this._callbacks[ev]=this._callbacks[ev]||[];this._callbacks[ev].push(callback);return this;};EventProxy.prototype.bind=EventProxy.prototype.addListener;EventProxy.prototype.on=EventProxy.prototype.addListener;EventProxy.prototype.subscribe=EventProxy.prototype.addListener;EventProxy.prototype.removeListener=function(ev,callback){var calls=this._callbacks,i,l;if(!ev){this._callbacks={};}else if(calls){if(!callback){calls[ev]=[];}else{var list=calls[ev];if(!list){return this;}
l=list.length;for(i=0;i<l;i++){if(callback===list[i]){list[i]=null;break;}}}}
return this;};EventProxy.prototype.unbind=EventProxy.prototype.removeListener;EventProxy.prototype.removeAllListeners=function(event){return this.unbind(event);};EventProxy.prototype.trigger=function(eventName,data){var list,ev,callback,args,i,l;var both=2;var calls=this._callbacks;while(both--){ev=both?eventName:'all';list=calls[ev];if(list){for(i=0,l=list.length;i<l;i++){if(!(callback=list[i])){list.splice(i,1);i--;l--;}else{args=both?Array.prototype.slice.call(arguments,1):arguments;callback.apply(this,args);}}}}
return this;};EventProxy.prototype.emit=EventProxy.prototype.trigger;EventProxy.prototype.fire=EventProxy.prototype.trigger;var later=typeof process!=='undefined'&&process.nextTick||function(fn){setTimeout(fn,0);};EventProxy.prototype.emitLater=function(){var self=this;var args=arguments;later(function(){self.trigger.apply(self,args);});};EventProxy.prototype.once=function(ev,callback){var self=this;var wrapper=function(){callback.apply(self,arguments);self.unbind(ev,wrapper);};this.bind(ev,wrapper);return this;};EventProxy.prototype.immediate=function(ev,callback,data){this.bind(ev,callback);this.trigger(ev,data);return this;};EventProxy.prototype.asap=EventProxy.prototype.immediate;var _assign=function(eventname1,eventname2,cb,once){var proxy=this,length,index=0,argsLength=arguments.length,bind,_all,callback,events,isOnce,times=0,flag={};if(argsLength<3){return this;}
events=Array.prototype.slice.apply(arguments,[0,argsLength-2]);callback=arguments[argsLength-2];isOnce=arguments[argsLength-1];if(typeof callback!=="function"){return this;}
length=events.length;bind=function(key){var method=isOnce?"once":"bind";proxy[method](key,function(data){proxy._fired[key]=proxy._fired[key]||{};proxy._fired[key].data=data;if(!flag[key]){flag[key]=true;times++;}});};for(index=0;index<length;index++){bind(events[index]);}
_all=function(event){if(times<length){return;}
if(!flag[event]){return;}
var data=[];for(index=0;index<length;index++){data.push(proxy._fired[events[index]].data);}
if(isOnce){proxy.unbind("all",_all);}
callback.apply(null,data);};proxy.bind("all",_all);};EventProxy.prototype.all=function(eventname1,eventname2,callback){var args=Array.prototype.concat.apply([],arguments);args.push(true);_assign.apply(this,args);return this;};EventProxy.prototype.assign=EventProxy.prototype.all;EventProxy.prototype.fail=function(callback){var that=this;that.once('error',function(err){that.unbind();callback(err);});return this;};EventProxy.prototype.tail=function(){var args=Array.prototype.concat.apply([],arguments);args.push(false);_assign.apply(this,args);return this;};EventProxy.prototype.assignAll=EventProxy.prototype.tail;EventProxy.prototype.assignAlways=EventProxy.prototype.tail;EventProxy.prototype.after=function(eventName,times,callback){if(times===0){callback.call(null,[]);return this;}
var proxy=this,firedData=[],all;this._after=this._after||{};var group=eventName+'_group';this._after[group]={index:0,results:[]};all=function(name,data){if(name===eventName){times--;firedData.push(data);if(times<1){proxy.unbind("all",all);callback.apply(null,[firedData]);}}
if(name===group){times--;proxy._after[group].results[data.index]=data.result;if(times<1){proxy.unbind("all",all);callback.call(null,proxy._after[group].results);}}};proxy.bind("all",all);return this;};EventProxy.prototype.group=function(eventName,callback){var that=this;var group=eventName+'_group';var index=that._after[group].index;that._after[group].index++;return function(err,data){if(err){return that.emit('error',err);}
that.emit(group,{index:index,result:callback?callback(data):data});};};EventProxy.prototype.any=function(){var proxy=this,index,_bind,len=arguments.length,callback=arguments[len-1],events=Array.prototype.slice.apply(arguments,[0,len-1]),count=events.length,_eventName=events.join("_");proxy.once(_eventName,callback);_bind=function(key){proxy.bind(key,function(data){proxy.trigger(_eventName,{"data":data,eventName:key});});};for(index=0;index<count;index++){_bind(events[index]);}};EventProxy.prototype.not=function(eventName,callback){var proxy=this;proxy.bind("all",function(name,data){if(name!==eventName){callback(data);}});};EventProxy.prototype.done=function(handler,callback){var that=this;return function(err,data){if(err){return that.emit('error',err);}
var args=Array.prototype.slice.call(arguments,1);if(typeof handler==='string'){return that.emit(handler,callback?callback.apply(null,args):data);}
if(arguments.length<=2){return handler(data);}
handler.apply(null,args);};};EventProxy.prototype.doneLater=function(handler,callback){var _doneHandler=this.done(handler,callback);return function(err,data){var args=arguments;later(function(){_doneHandler.apply(null,args);});};};EventProxy.create=function(){var ep=new EventProxy();var args=Array.prototype.concat.apply([],arguments);if(args.length){var errorHandler=args[args.length-1];var callback=args[args.length-2];if(typeof errorHandler==='function'&&typeof callback==='function'){args.pop();ep.fail(errorHandler);}
ep.assign.apply(ep,Array.prototype.slice.call(args));}
return ep;};EventProxy.EventProxy=EventProxy;return EventProxy;});