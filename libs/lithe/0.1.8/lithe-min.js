/**
* @author xiaojue[designsor@gmail.com]
* @fileoverview lithe main file
* @version 0.1.2
*/(function(e,t){var n=typeof window!==t&&!!e.navigator&&!!e.document;if(n){var r={},i=e.document,s=e.location,o=function(){},u=Array.prototype,a=Object,f,l,c="utf-8",h=a.prototype.toString,p=i.head||i.getElementsByTagName("head")[0]||i.documentElement,d=navigator.userAgent,v=i.getElementsByTagName("script"),m=v[v.length-1],g=function(e,t){return e.getAttribute(t)},y=g(m,"data-path")||m.src||g(m,"src"),b=g(m,"data-config"),w=g(m,"data-debug")==="true",E=g(m,"data-main"),S=p.getElementsByTagName("base")[0],x=/(\/\*([\s\S]*?)\*\/|([^:]|^)\/\/(.*)$)/mg,T=/[^.]\s*require\s*\(\s*["']([^'"\s]+)["']\s*\)/g,N={},C={},k={},L=[],A=[],O,M,_=[],D={},P=function(e,t){if(arguments.length===1)return e;for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);return e},H=P({isString:function(e){return h.call(e)==="[object String]"},isFunction:function(e){return h.call(e)==="[object Function]"},isObject:function(e){return e===a(e)},forEach:u.forEach?function(e,t){e.forEach(t)}:function(e,t){for(var n=0;n<e.length;n++)t(e[n],n,e)},filter:u.filter?function(e,t){return e.filter(t)}:function(e,t){var n=[];return H.forEach(e,function(e,r,i){t(e,r,i)&&n.push(e)}),n},map:u.map?function(e,t){return e.map(t)}:function(e,t){var n=[];return H.forEach(e,function(e,r,i){n.push(t(e,r,i))}),n},keys:a.keys?a.keys:function(e){var t=[];for(var n in e)e.hasOwnProperty(n)&&t.push(n);return t},indexOf:u.indexOf?function(e,t){return e.indexOf(t)}:function(e,t){for(var n=0;n<e.length;n++)if(e[n]===t)return n;return-1},unique:function(e){var t={};return H.forEach(e,function(e){t[e]=1}),H.keys(t)},_createNode:function(e,t){var n=i.createElement(e);return t&&(n.charset=t),n},_insertScript:function(e){S?p.insertBefore(e,S):p.appendChild(e)},getScript:function(e,n,r){var i=H._createNode("script",r);i.onload=i.onerror=i.onreadystatechange=function(){/loaded|complete|undefined/.test(i.readyState)&&(i.onload=i.onerror=i.onreadystatechange=null,i.parentNode&&!w&&i.parentNode.removeChild(i),i=t,H.isFunction(n)&&n())},i.async="async",i.src=e,O=i,H._insertScript(i),O=null},_fetch:function(e,t){if(k[e]){t();return}if(N[e]){C[e].push(t);return}N[e]=!0,C[e]=[t],H.getScript(e,function(){k[e]=!0,delete N[e];var t=C[e];t&&(delete C[e],H.forEach(t,function(e){e()}))},c)},getDependencies:function(e){var t=[];return e.replace(x,"").replace(T,function(e,n){t.push(n)}),H.unique(t)},fixNameSpace:function(e,t){var n=H.findPathNameSpace(e);return H.map(t,function(e){var t=H.getNameSpace(e);return n!=t&&t=="_main"?n+":"+e:e})},findPathNameSpace:function(e){for(var t in r)if((new RegExp("^"+r[t].basepath)).test(e))return t;return"_main"},getPureDependencies:function(e){var t=e.id;e.dependencies=H.fixNameSpace(t,e.dependencies);var n=H.filter(e.dependencies,function(e){L.push(t);var n=H.isCircularWaiting(B.cache[e]);return n&&L.push(t),L.pop(),!n});return H.createUrl(n)},isCircularWaiting:function(e){if(!e||e.status!==B.status.save)return!1;L.push(e.uri);var t=e.dependencies;if(t.length){if(H.isOverlap(t,L))return!0;for(var n=0;n<t.length;n++)if(H.isCircularWaiting(B.cache[t[n]]))return!0}return L.pop(),!1},isOverlap:function(e,t){var n=e.concat(t);return n.length>H.unique(n).length},runModuleContext:function(e,n){var r;try{r=e(n.require,n.exports,n)}catch(i){throw n.id+":"+i}r!==t&&(n.exports=r)},dirname:function(e){var t=e.match(/[^?]*(?=\/.*$)/);return(t?t[0]:".")+"/"},realpath:function(e){var t=/([^:\/])\/\/+/g;t.lastIndex=0,t.test(e)&&(e=e.replace(t,"$1/"));if(e.indexOf(".")===-1)return e;var n=e.split("/"),r=[],i;for(var s=0;s<n.length;s++){i=n[s];if(i===".."){if(r.length===0)throw new Error("The path is invalid: "+e);r.pop()}else i!=="."&&r.push(i)}return r.join("/")},normalize:function(e){e=H.realpath(e);var t=e.charAt(e.length-1);return t==="/"?e:(t==="#"?e=e.slice(0,-1):e.indexOf("?")===-1&&!/\.(?:js)$/.test(e)&&(e+=".js"),e.indexOf(":80/")>0&&(e=e.replace(":80/","/")),e)},resolve:function(e,t){var n="";return e?(e.indexOf("./")===0||e.indexOf("../")===0?(e.indexOf("./")===0&&(e=e.substring(2)),n=H.dirname(t)+e):e.charAt(0)==="/"&&e.charAt(1)!=="/"?n=H.dirname(t)+e.substring(1):n=H.dirname(t)+"/"+e,H.normalize(n)):n},isAbsolute:function(e){return e.indexOf("://")>0||e.indexOf("//")===0},filename:function(e){return e.slice(e.lastIndexOf("/")+1).replace(/\?.*$/,"")},getNameSpace:function(e){if(H.isAbsolute(e))return"_main";var t=e.split(":");return t[1]?t[0]:"_main"},replaceDir:function(e,t){var n={};for(var r=0;r<t.length;r++){var i=t[r];for(var s in i){var o=i[s],u=new RegExp("^"+s+"/");if(u.test(e)&&!n[e]){e=e.replace(u,o),n[e]=!0;break}}if(n[e])break}return H.isAbsolute(e)&&(e=H.normalize(e)),e},isDir:function(e){return e.lastIndexOf("/")===e.length-1},getAliasDir:function(e){var t=[];for(var n in e)if(H.isDir(e[n])){var r={};r[n]=e[n],t.push(r)}return t},createUrl:function(e){return H.map(e,function(e){var t=H.getNameSpace(e);t!=="_main"&&(e=e.split(":")[1]),r.hasOwnProperty(e)&&(t=e);var n=r[t];if(n){var i=H.getAliasDir(n.alias);if(n.alias){var s=n.alias[e];s&&!H.isDir(s)?e=s:i.length&&(e=H.replaceDir(e,i))}return H.isAbsolute(e)||(e=H.resolve(e,n.basepath)),n.timestamp&&(e=e+"?"+n.timestamp),e}throw new Error("the namespace "+t+" is not found!")})},buildNameSpace:function(e,t){H.addConfigs(e,function(e){H.forEach(e,function(e){var t=r[e.name];t.alias=e.alias,t.timestamp=e.timestamp}),t&&t()})},_hasClear:function(e,t){return delete e[t],H.keys(e).length?!1:!0},addConfigs:function(e,t,n){var i=n||H.keys(r).length;if(H.keys(r).length===1){e.name="_main",t([e]);return}for(var s in r){var o=r[s].config;if(s==="_main")continue;if(D[s])continue;(function(e,n){D[n]=!0,B.use(n+":"+e,function(e){e.name=n,_.push(e),H.addNameSpace(e);var s=H.keys(r).length;s>i&&H.addConfigs(e,t,s);var o=H._hasClear(D,n);o&&t(_)})})(o,s)}},addNameSpace:function(e){if(e.hasOwnProperty("namespace"))for(var t in e.namespace){var n=e.namespace[t];r[t]={basepath:n.basepath,config:n.config}}},getCurrentScript:function(){if(O)return O;if(M&&M.readyState==="interactive")return M;var e=p.getElementsByTagName("script");for(var t=e.length-1;t>=0;t--){var n=e[t];if(n.readyState==="interactive")return M=n,M}return M},pathToid:function(e,t){var n=H.findPathNameSpace(e);t=t||H.filename(e);var r=n==="_main"?t:n+":"+t;return H.createUrl([r])[0]},_save:function(e){H.forEach(A,function(t){if(!t.id)throw new Error("more than ones anonymouse define in one file!");t.id=H.pathToid(e,t.id),B._save(t.id,t)})}});r._main={basepath:H.dirname(y),config:b};function B(e){this.id=e,this.status=0,this.dependencies=[],this.exports=null,this.parent=[],this.factory=o}P(B,{cache:{},status:{created:0,save:1,ready:2,compiling:3,compiled:4},_get:function(e){return B.cache[e]||(B.cache[e]=new B(e))},_save:function(e,t){var n=this._get(e);n.status<B.status.save&&(n.id=e||t.id,n.dependencies=t.deps,n.factory=t.factory,n.status=B.status.save)},define:function(e,n){H.isFunction(e)&&(n=e,e=t);if(!H.isFunction(n))throw"define failed";var r=H.getDependencies(n.toString()),s={deps:r,factory:n};e&&H.isAbsolute(e)&&(s.id=e);if(!s.id&&i.attachEvent){var o=H.getCurrentScript();if(!o)throw new Error('failed to derive:" '+n);s.id=o.src}s.id?B._save(s.id,s):(s.id=e,A.push(s))},_createUrls:function(e){H.isString(e)&&(e=[e]);var t=H.createUrl(e);return t},use:function(e,t){var n=B._createUrls(e);B._fetch(n,function(){var e=H.map(n,function(e){return e?B.cache[e]._compile():null});H.isFunction(t)&&t.apply(null,e)})},_preload:function(e,t){var n=B._createUrls(e)[0];H._fetch(n,function(){var e=A.length;e&&(e>1?H._save(n):B._save(n,A[0]),A=[]),t()})},_fetch:function(e,t){var n=B.status,r=H.filter(e,function(e){return e&&(!B.cache[e]||B.cache[e].status<n.ready)}),i=function(e){(e||{}).status<n.ready&&(e.status=n.ready),--o,o===0&&t()},s=r.length;if(s===0){t();return}var o=s;for(var u=0;u<s;u++)(function(e){function r(){var r=A.length;r&&(r>1?H._save(e):B._save(e,A[0]),A=[]),t=B._get(e);if(t.status>=n.save){var s=H.getPureDependencies(t);s.length?B._fetch(s,function(){i(t)}):i(t)}else i()}var t=B._get(e);t.status<B.status.save?H._fetch(e,r):r()})(r[u])}}),P(B.prototype,{_compile:function(){function n(n){for(var r in e.dependencies){var i=e.dependencies[r],s=H.getNameSpace(i);s!="_main"&&n==i.split(":")[1]&&(n=s+":"+n)}n=H.createUrl([n]);var o=B.cache[n];return o?o.status===t.compiled?o.exports:(o.parent=e,o._compile()):null}var e=this,t=B.status;if(e.status===t.compiled)return e.exports;if(e.status<t.save)return null;e.status=t.compiling,n.cache=B.cache,e.require=n,e.exports={};var r=e.factory;return H.isFunction(r)&&H.runModuleContext(r,e),e.status=t.compiled,e.exports}});function j(e,t){B.use(b,function(n){H.addNameSpace(n),H.buildNameSpace(n,function(){var i=r._main;i.alias=n.alias,i.timestamp=n.timestamp,n.basepath&&(i.basepath=n.basepath),w&&H.isFunction(n.debugswitch)&&(e=n.debugswitch(e)||e),B.use(e,t)})})}e.define=B.define,e.lithe=P({use:B.use,cache:B.cache,NAMESPACE:r,start:function(e,t){b?w?j(e,t):B._preload(e,function(){j(e,t)}):B.use(e,t)}}),E&&e.lithe.start(E)}else exports.tool=require("./lib/lithe-tool.js"),exports.hfs=require("./lib/lithe-hfs.js")})(this);