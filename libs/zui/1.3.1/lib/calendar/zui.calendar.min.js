/*!
 * ZUI - v1.3.1 - 2015-05-19
 * http://zui.sexy
 * GitHub: https://github.com/easysoft/zui.git 
 * Copyright (c) 2015 cnezsoft.com; Licensed MIT
 */

!function(a,b){"use strict";var c="zui.calendar",d="number",e="string",f="undefined",g={primary:1,green:2,red:3,blue:4,yellow:5,brown:6,purple:7},h=function(a,b){b=b||1;for(var c=a.clone();c.getDay()!=b;)c.addDays(-1);return c.clearTime(),c},i=function(a){var b=a.clone();return b.setDate(1),b},j=function(a,b){var c=a.clone().clearTime(),d=b.clone().clearTime();return Math.round((d.getTime()-c.getTime())/Date.ONEDAY_TICKS)+1},k=function(a,b,c){for(var d=a.clone(),e=0;b>=d;)c(d.clone(),e++),d.addDays(1)},l=function(b,d){if(this.name=c,this.$=a(b),this.id=this.$.attr("id")||c+a.zui.uuid(),this.$.attr("id",this.id),this.storeName=c+"."+this.id,this.getOptions(d),this.getLang(),this.data=this.options.data,this.addCalendars(this.data.calendars),this.addEvents(this.data.events),this.sortEvents(),this.storeData=a.zui.store.pageGet(this.storeName,{date:"today",view:"month"}),this.date=this.options.startDate||"today",this.view=this.options.startView||"month",this.date="today",this.$.toggleClass("limit-event-title",d.limitEventTitle),this.options.withHeader){var e=this.$.children(".calender-header");e.length||(e=a('<header><div class="btn-toolbar"><div class="btn-group"><button type="button" class="btn btn-today">{today}</button></div><div class="btn-group"><button type="button" class="btn btn-prev"><i class="icon-chevron-left"></i></button><button type="button" class="btn btn-next"><i class="icon-chevron-right"></i></button></div><div class="btn-group"><span class="calendar-caption"></span></div></div></header>'.format(this.lang)),this.$.append(e)),this.$caption=e.find(".calendar-caption"),this.$todayBtn=e.find(".btn-today"),this.$header=e}var f=this.$.children(".calendar-views");f.length||(f=a('<div class="calendar-views"></div>'),this.$.append(f)),this.$views=f,this.$monthView=f.children(".calendar-view.month"),this.display(),this.bindEvents()};l.DEFAULTS={langs:{zh_cn:{weekNames:["周一","周二","周三","周四","周五","周六","周日"],monthNames:["一月","二月","三月","四月","五月","六月","七月","八月","九月","十月","十一月","十二月"],today:"今天",year:"{0}年",month:"{0}月",yearMonth:"{0}年{1}月"},zh_tw:{weekNames:["週一","週二","週三","週四","週五","週六","週日"],monthNames:["一月","二月","三月","四月","五月","六月","七月","八月","九月","十月","十一月","十二月"],today:"今天",year:"{0}年",month:"{0}月",yearMonth:"{0}年{1}月"},en:{weekNames:["Mon","Tue","Wed","Thu","Fri","Sat","Sun"],monthNames:["Jan","Feb","Mar","Apr","May","June","July","Aug","Sep","Oct","Nov","Dec"],today:"Today",year:"{0}",month:"{0}",yearMonth:"{2}, {0}"}},data:{calendars:{defaultCal:{color:"#229F24"}},events:[]},limitEventTitle:!0,storage:!0,withHeader:!0,dragThenDrop:!0},l.prototype.sortEvents=function(){var b=this.events;a.isArray(b)||(b=[]),b.sort(function(a,b){return a.start>b.start?1:a.start<b.start?-1:0})},l.prototype.bindEvents=function(){var b=this.$,c=this;b.on("click",".btn-today",function(){c.date=new Date,c.display(),c.callEvent("clickTodayBtn")}).on("click",".btn-next",function(){"month"===c.view&&c.date.addMonths(1),c.display(),c.callEvent("clickNextBtn")}).on("click",".btn-prev",function(){"month"===c.view&&c.date.addMonths(-1),c.display(),c.callEvent("clickPrevBtn")}).on("click",".event",function(b){c.callEvent("clickEvent",{element:this,event:a(this).data("event"),events:c.events}),b.stopPropagation()}).on("click",".cell-day",function(){c.callEvent("clickCell",{element:this,view:c.view,date:new Date(a(this).children(".day").attr("data-date")),events:c.events})})},l.prototype.addCalendars=function(b,c){var d=this;d.calendars||(d.calendars={}),a.isPlainObject(b)&&(b=[b]),a.each(b,function(b,e){if(c||d.callEvent("beforeAddCalendars",{newCalendar:e,data:d.data})){if(e.color||(e.color="primary"),g[e.color.toLowerCase()])e.presetColor=!0;else{var f=new a.zui.Color(e.color);e.textColor=f.contrast().hexStr()}d.calendars[e.name]=e}}),c||(d.display(),d.callEvent("addCalendars",{newCalendars:b,data:d.data}))},l.prototype.addEvents=function(b,c){var g=this;g.events||(g.events=[]),a.isPlainObject(b)&&(b=[b]),a.each(b,function(b,h){if(c||g.callEvent("beforeAddEvent",{newEvent:h,data:g.data})){var i=typeof h.start,k=typeof h.end;(i===d||i===e)&&(h.start=new Date(h.start)),(k===d||k===e)&&(h.end=new Date(h.end)),typeof h.id===f&&(h.id=a.zui.uuid()),h.allDay&&(h.start.clearTime(),h.end.clearTime().addDays(1).addMilliseconds(-1)),h.days=j(h.start,h.end),g.events.push(h)}}),c||(g.sortEvents(),g.display(),g.callEvent("addEvents",{newEvents:b,data:g.data}))},l.prototype.getEvent=function(a){for(var b=this.events,c=0;c<b.length;c++)if(b[c].id==a)return b[c];return null},l.prototype.updateEvents=function(b){var c={data:this.data,changes:[]},d=this;a.isPlainObject(b)&&(b=[b]);var f,g,h;a.each(b,function(b,i){f=i.event,g=i.changes,h={event:f,changes:[]},typeof f===e&&(f=d.getEvent(f)),f&&(a.isPlainObject(g)&&(g=[g]),a.each(function(b,c){d.callEvent("beforeChange",{event:f,change:c.change,to:c.to,from:f[c.change]})&&(h.changes.push(a.entend(!0,{},c,{from:f[c.change]})),f[c.change]=c.to)})),c.changes.push(h)}),d.sortEvents(),d.display(),d.callEvent("change",c)},l.prototype.removeEvents=function(b){a.isArray(b)||(b=[b]);var c,d,e,f=this.events,g=this,h=[];a.each(b,function(b,i){c=a.isPlainObject(i)?i.id:i,e=-1;for(var j=0;j<f.length;j++)if(f[j].id==c){e=j,d=f[j];break}e>=0&&g.callEvent("beforeRemoveEvent",{event:d,eventId:c,data:g.data})&&(f.splice(e,1),h.push(d))}),g.sortEvents(),g.display(),g.callEvent("removeEvents",{removedEvents:h,data:g.data})},l.prototype.getOptions=function(b){this.options=a.extend({},l.DEFAULTS,this.$.data(),b)},l.prototype.getLang=function(){this.lang=this.options.langs[this.options.lang||a.zui.clientLang()]},l.prototype.display=function(b,c){var d=this,g=typeof b,h=typeof c;g===f?b=d.view:d.view=b,h===f?c=d.date:d.date=c,"today"===c&&(c=new Date,d.date=c),typeof c===e&&(c=new Date(c),d.date=c),d.options.storage&&a.zui.store.pageSet(d.storeName,{date:c,view:b});var i={view:b,date:c};if(d.callEvent("beforeDisplay",i)){switch(b){case"month":d.displayMonth(c)}d.callEvent("display",i)}},l.prototype.displayMonth=function(b){var c=this;b=b||c.date;var d,e=c.options,f=c,g=c.lang,j=c.$views,k=c.$,l=f.$monthView;if(!l.length){l=a('<div class="calendar-view month"><table class="table table-bordered"><thead><tr class="week-head"></tr></thead><tbody class="month-days"></tbody></table></div>');var m,n=l.find(".week-head"),o=l.find(".month-days");for(d=0;7>d;d++)n.append("<th>"+g.weekNames[d]+"</th>");for(d=0;6>d;d++){m=a('<tr class="week-days"></tr>');for(var p=0;7>p;p++)m.append('<td class="cell-day"><div class="day"><div class="heading"><span class="month"></span> <span class="number"></span></div><div class="content"><div class="events"></div></div></div></td>');o.append(m)}j.append(l),f.$monthView=l}var q,r,s,t,u,v,w,x,y,z,A,B=l.find(".week-days"),C=l.find(".day"),D=i(b),E=new Date,F=h(D),G=b.getFullYear(),H=b.getMonth(),I=E.getMonth(),J=E.getFullYear(),K=E.getDate(),L=F.clone().addDays(42).addMilliseconds(-1),M=F.clone().addDays(1).addMilliseconds(-1),N=c.getEvents(F,L),O=c.calendars;B.each(function(b){q=a(this),q.find(".day").each(function(c){x=0===c,r=a(this),s=r.closest(".cell-day"),t=M.getFullYear(),u=M.getDate(),v=M.getMonth(),w=M.toDateString(),r.attr("data-date",w),r.find(".heading > .number").text(u),r.find(".heading > .month").toggle(0===b&&0===c||1===u).text((0===v&&1===u?g.year.format(t)+" ":"")+g.monthNames[v]),s.toggleClass("current-month",v===H),s.toggleClass("current",u===K&&v===I&&t===J),s.toggleClass("past",E>M),s.toggleClass("future",M>E),A=r.find(".events").empty();var e=N[w];if(e){var f,h=e.events,i=0;for(d=0;d<=e.maxPos;++d)f=h[d],!f||f.placeholder&&!x?i++:(y=a('<div data-id="'+f.id+'" class="event" title="'+f.desc+'"><span class="time">'+f.start.format("hh:mm")+'</span> <span class="title">'+f.title+"</span></div>"),y.find(".time").toggle(!f.allDay),y.data("event",f),y.attr("data-days",f.days),f.calendar&&(z=O[f.calendar],z&&(z.presetColor?y.addClass("color-"+z.color):y.css({"background-color":z.color,color:z.textColor}))),f.days&&(f.placeholder?x&&y.css("width",Math.min(7,f.days-f.holderPos)+"00%"):y.css("width",Math.min(7-c,f.days)+"00%")),i>0&&(y.css("margin-top",22*i),i=0),A.append(y))}M.addDays(1)})}),e.withHeader&&(c.$caption.text(g.yearMonth.format(G,H+1,g.monthNames[H])),c.$todayBtn.toggleClass("disabled",H===I)),e.dragThenDrop&&l.find(".event").droppable({target:C,container:l,flex:!0,start:function(){k.addClass("event-dragging")},drop:function(a){var b=a.element.data("event"),d=a.target.attr("data-date"),e=b.start.clone();if(e.toDateString()!=d&&(d=new Date(d),d.setHours(e.getHours()),d.setMinutes(e.getMinutes()),d.setSeconds(e.getSeconds()),f.callEvent("beforeChange",{event:b,change:"start",to:d}))){var g=b.end.clone();b.end.addMilliseconds(b.end.getTime()-e.getTime()),b.start=d,c.display(),f.callEvent("change",{data:f.data,changes:[{event:b,changes:[{change:"start",from:e,to:b.start},{change:"end",from:g,to:b.end}]}]})}},finish:function(){k.removeClass("event-dragging")}})},l.prototype.getEvents=function(b,c){var d={},e=(this.calendars,function(a,b,c){var e=a.toDateString(),f=d[e];if(f||(f={maxPos:-1,events:{}}),"undefined"==typeof c)for(var g=0;100>g;++g)if(!f.events[g]){c=g;break}return f.maxPos=Math.max(c,f.maxPos),f.events[c]=b,d[e]=f,c});return a.each(this.events,function(d,f){if(f.start>=b&&f.start<=c){var g=e(f.start,f);if(f.days>1){var h=a.extend({placeholder:!0},f);k(f.start.clone().addDays(1),f.end,function(b,c){e(b.clone(),a.extend({holderPos:c},h),g)})}}}),d},l.prototype.callEvent=function(a,b){var c=this.$.callEvent(a+"."+this.name,b,this);return!(void 0!==c.result&&!c.result)},a.fn.calendar=function(b){return this.each(function(){var d=a(this),f=d.data(c),g="object"==typeof b&&b;f||d.data(c,f=new l(this,g)),typeof b==e&&f[b]()})},a.fn.calendar.Constructor=l}(jQuery,window);